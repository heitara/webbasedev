<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    
<sqlMap namespace="playHist">

	<resultMap class="com.gameif.portal.entity.PlayHist" id="playHistResult">
		<result property="memNum" column="mem_num" />
		<result property="titleId" column="title_id" />
		<result property="serverId" column="server_id" />
		<result property="playDate" column="play_date" />
	</resultMap>
	
	<resultMap class="com.gameif.portal.entity.MyTitle" id="myTitleResult">
		<result property="titleId" column="title_id"/>
		<result property="titleName" column="title_name"/>
		<result property="titleAbout" column="title_about"/>
		<result property="serviceStatus" column="service_status"/>
		<result property="siteUrl" column="site_url"/>
		<result property="newsUrl" column="news_url"/>
		<result property="forumUrl" column="forum_url"/>
		<result property="paymentUrl" column="payment_url"/>
		<result property="bigIconUrl" column="big_icon_url"/>
		<result property="smallIconUrl" column="small_icon_url"/>
		<result property="orderNum" column="order_num"/>
		<result property="playersNum" column="players_num"/>
		<result property="announce" column="announce"/>
		<result property="playDate" column="play_date"/>
		<result property="playCount" column="play_count"/>
	</resultMap>

	<insert id="save" parameterClass="com.gameif.portal.entity.PlayHist">
	<![CDATA[
		INSERT INTO play_hist
			(
			mem_num,
			title_id,
			server_id,
			play_date
			)
		VALUES
			(
			#memNum#,
			#titleId#,
			#serverId#,
			#playDate#
			)
	]]>
	</insert>

	<select id="selectTitlesOnlyPlay" resultMap="myTitleResult">
        <![CDATA[
		SELECT
			t.title_id,
			t.title_name,
			t.title_about,
			t.service_status,
			t.site_url,
			t.news_url,
			t.forum_url,
			t.payment_url,
			t.big_icon_url,
			t.small_icon_url,
			t.order_num,
			t.players_num,
			t.announce,
			p.play_date,
			p.play_count
		FROM	title_mst t INNER JOIN (
					SELECT	title_id, MAX(play_date) AS play_date, COUNT(*) AS play_count
					FROM	play_hist
					WHERE	mem_num = #value#
					GROUP BY title_id
				) p ON t.title_id = p.title_id
		ORDER BY p.play_date DESC, p.play_count DESC, t.order_num DESC
        ]]>
	</select>

	<select id="selectTitlesWithPlay" resultMap="myTitleResult">
        <![CDATA[
		SELECT
			t.title_id,
			t.title_name,
			t.title_about,
			t.service_status,
			t.site_url,
			t.news_url,
			t.forum_url,
			t.payment_url,
			t.big_icon_url,
			t.small_icon_url,
			t.order_num,
			t.players_num,
			t.announce,
			p.play_date,
			p.play_count
		FROM	title_mst t LEFT JOIN (
					SELECT	title_id, MAX(play_date) AS play_date, COUNT(*) AS play_count
					FROM	play_hist
					WHERE	mem_num = #value#
					GROUP BY title_id
				) p ON t.title_id = p.title_id
		ORDER BY p.play_date DESC, p.play_count DESC, t.order_num DESC
        ]]>
	</select>

</sqlMap>