<?xml version="1.0" encoding="UTF-8"?>

<Module>
	<ModulePrefs title="Hello, world!">
		<Require feature="opensocial-0.8" />
		<Require feature="dynamic-height" />
	</ModulePrefs>
	
	<Content type="html" view="home"><![CDATA[
<style>
div.g_mx_profile {
	margin:auto;
	width:210px;
	height:210px;
	background:url(http://test.www.game-if.com/opensocial/images/opensocial/mixi/mixi_home.jpg) no-repeat center;
	text-align:right;
}
div.g_mx_profile a {
	font-weight:bold;
	color:#FFF;
	font-size:12px;
	text-decoration:none;
	margin-top:5px;
	margin-right:8px;
	width:84px;
	height:18px;
	line-height:18px;
	display:inline-block;
	text-align:center;
}
div.g_mx_profile a:hover {
	color:#FC3;
}
</style>
<div class="g_mx_profile">
	<a href="http://mixi.jp/view_appli.pl?id=20792" target="_top" title="「レジオン-創世伝説- for mixi」をプレイする。">スタート</a>
</div>
<script>
gadgets.window.adjustHeight(220);
</script>
	]]></Content>

	<Content type="html" view="profile"><![CDATA[
<style>
div.g_mx_profile {
	margin:auto;
	width:210px;
	height:210px;
	background:url(http://test.www.game-if.com/opensocial/images/opensocial/mixi/mixi_profile.jpg) no-repeat center;
	text-align:right;
}
div.g_mx_profile a {
	font-weight:bold;
	color:#FFF;
	font-size:12px;
	text-decoration:none;
	margin-top:5px;
	margin-right:8px;
	width:84px;
	height:18px;
	line-height:18px;
	display:inline-block;
	text-align:center;
}
div.g_mx_profile a:hover {
	color:#FC3;
}
</style>
<div class="g_mx_profile">
	<a href="http://mixi.jp/view_appli.pl?id=20792" target="_top" title="「レジオン-創世伝説- for mixi」をプレイする。">スタート</a>
</div>
<script>
gadgets.window.adjustHeight(220);
</script>
	]]></Content>

	<Content type="html" view="canvas"><![CDATA[
<style>
table.mx_g_top {
	width:945px;
}
div.mx_g_server {
	font-size:12px;
	font-weight:bold;
	color:#F60;
	height:18px;
}
div.mx_g_start {
	font-size:10px;
	margin-bottom:10px;
}
td.mx_g_menu {
	text-align:right;
	line-height:18px;
}
td.mx_g_menu a {
	display:inline-block;
	width:120px;
	height:26px;
	font-size:12px;
	line-height:26px;
	text-align:center;
	color:#FFF;
	font-weight:bold;
	text-decoration:none;
	background:url(http://test.www.game-if.com/opensocial/images/opensocial/mixi/bg_btn_mxi_legion.gif);
}
td.mx_g_menu a:visited {
	color:#FFF;
}
td.mx_g_menu a:hover {
	color:#FC3;
}

table.mx_g_bottom {
	width:945px;
	background-color:#222;
}
table.mx_g_bottom tr {
	height:76px;
	vertical-align:middle;
}
table.mx_g_bottom tr td.previous {
	width:16px;
	text-align:left;
}
table.mx_g_bottom tr td.next {
	width:16px;
	text-align:right;
}
table.mx_g_bottom tr td.thumb {
	width:76px;
	text-align:center;
	background-color:#FFF;
	border:solid 2px #FFF;
}
table.mx_g_bottom tr td.detail {
	color:#FFF;
}
table.mx_g_bottom tr td a img {
	border:0px;
}
div.friend_detail table tr {
	height:20px;
	font-size:12px;
	color:#FFF;
}
div.friend_detail table tr th {
	width:70px;
	text-align:center;
	border:1px solid #333;
	background-color:#111;
	font-weight:normal;
	color:#BBB;
}
div.friend_detail table tr td.data {
	width:100px;
	padding-left:5px;
	text-align:left;
	line-height:10px;
}
div.friend_detail table tr td.op {
	vertical-align:top;
}
div.friend_detail table tr td.message {
	vertical-align:top;
	width:365px;
}
div#start table tr td {
	line-height:17px;
	padding-right:5px;
}
div#start table tr td a {
	color:#FFF;
}
div#start table tr td a:hover {
	color:#F90;
}
</style>

<div id="proxyScript" style="display:none;"></div>
<div id="target"></div>
<table class="mx_g_bottom" cellpadding="0" cellspacing="5" border="0" style="margin-top:1px;">
	<tr valign="middle">
		<td class="previous"><a href="javascript:_doShowPreviousFriendList();"><img src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/btn_previous.png" alt="友達を誘いましょう！"/></a></td>
		<td class="thumb" id="thumbCell0"><a id="friend0" href="javascript:_inviteFriends();" title="友達を誘いましょう！"><img id="friendThumb0" src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/img_no_friend.gif" alt="友達を誘いましょう！"/></a></td>
		<td class="thumb" id="thumbCell1"><a id="friend1" href="javascript:_inviteFriends();" title="友達を誘いましょう！"><img id="friendThumb1" src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/img_no_friend.gif" alt="友達を誘いましょう！"/></a></td>
		<td class="thumb" id="thumbCell2"><a id="friend2" href="javascript:_inviteFriends();" title="友達を誘いましょう！"><img id="friendThumb2" src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/img_no_friend.gif" alt="友達を誘いましょう！"/></a></td>
		<td class="thumb" id="thumbCell3"><a id="friend3" href="javascript:_inviteFriends();" title="友達を誘いましょう！"><img id="friendThumb3" src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/img_no_friend.gif" alt="友達を誘いましょう！"/></a></td>
		<td class="thumb" id="thumbCell4"><a id="friend4" href="javascript:_inviteFriends();" title="友達を誘いましょう！"><img id="friendThumb4" src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/img_no_friend.gif" alt="友達を誘いましょう！"/></a></td>
		<td class="next" align="right"><a href="javascript:_doShowNextFriendList();"><img src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/btn_next.png" alt="友達を誘いましょう！"/></a></td>
		<td class="detail">
			<div id="start" class="friend_detail" style="block;">
				<table width="100%">
					<tr>
						<td><img src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/adv_invite.png"/></td>
						<td align="right">
							<a href="javascript:mixi.util.requestExternalNavigateTo('http://mixi.legion.game-if.com');">レジオンとは</a><br/>
							<a href="javascript:mixi.util.requestExternalNavigateTo('http://mixi.legion.game-if.com/guide/guide_start.php');">スタート案内</a><br/>
							<a href="javascript:mixi.util.requestExternalNavigateTo('http://mixi.legion.game-if.com/guide/guide_quest1.php');">初心者クエスト</a><br/>
							<a href="javascript:mixi.util.requestExternalNavigateTo('http://mixi.legion.game-if.com/support/faq.php');">よくある質問</a><br/>
						</td>
					</tr>
				</table>
			</div>
			<div id="friend_detail" class="friend_detail" style="display:none;">
				<table cellspacing="3">
					<tr>
						<th>領主名</th>
						<td class="data"><span id="g_leader"></span></td>
						<th>主城</th>
						<td class="data"><span id="g_city"></span><div style="font-size:10px;margin-left:1px;">[ <span id="g_city_x"></span>, <span id="g_city_y"></span> ]</div></td>
						<td class="op" rowspan="3">
							<a href="javascript:_doSendMessage();"><img src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/btn_send_message.gif"/></a>
							<a href="javascript:_doSendGameFriendRequest();"><img src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/btn_game_friend.gif" style="margin-top:3px;"/></a>
						</td>
					</tr>
					<tr>
						<th>信仰神</th>
						<td class="data"><span id="g_gods"></span></td>
						<th>種族</th>
						<td class="data"><span id="g_race"></span></td>
					</tr>
					<tr>
						<th>信仰値</th>
						<td class="data"><span id="g_godliness"></span></td>
						<th>ギルド</th>
						<td class="data"><span id="g_church"></span></td>
					</tr>
				</table>
			</div>
			<div id="friend_finish" class="friend_detail" style="display:none;">
				<table cellspacing="3" height="76">
					<tr>
						<td class="message">
							<h3 id="success_message">メッセージを送信しました。</h3>ご利用ありがとうございました。
						</td>
						<td class="op">
							<a href="javascript:_doBackToFriendDetail();"><img src="http://test.www.game-if.com/opensocial/images/opensocial/mixi/btn_back.gif"/></a>
						</td>
					</tr>
				</table>
			</div>
		</td>
	</tr>
</table>

<script type="text/javascript">

var _gameIFProxyUrl = "http://test.www.game-if.com/opensocial/proxyTitleIF.html";
var _gameIFServletUrl = "http://test.www.game-if.com/opensocial/titlePlay.html";
var _legionGuideUrl = "http://mixi.legion.game-if.com/";
var _providerId = "1";
var _titleId = "1";
var _serverId = null;

var _userId = null;
var _nickname = null;

function _inviteFriends() {
	
	document.getElementById('mx_g_screen').style.visibility = 'hidden';
	
	opensocial.requestShareApp("VIEWER_FRIENDS", null, function(response) {
	
		if (response.hadError()) {
		
			var errCode = response.getErrorCode();
		
		} else {
		
			var recipientIds = response.getData()["recipientIds"];
			
			if (recipientIds.length > 0) {
			
				//console.log(_getGameIFInviteFriendParam(recipientIds.join("|")));
				gadgets.io.makeRequest(_gameIFServletUrl, function(resdata) {}, _getGameIFInviteFriendParam(recipientIds.join("|")));
			}
		}
	
		document.getElementById('mx_g_screen').style.visibility = 'visible';
	});
}

function _getGameIFInviteFriendParam(friendIds) {

	var params = _getGameIFBaseParam();
	
	var postData = {};
	
	postData["providerId"] = _providerId;
	postData["titleId"] = _titleId;
	
	postData["act"] = "invite";
	postData["memId"] = _userId;
	postData["friendIds"] = friendIds;
	
	params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(postData);
	
	//console.log(params);
	return params;
}

function _openGuidePage() {

	var windW = 800;
	var windH = screen.height - 220;
	var windL = (screen.width - windW) / 2;
	var windT = 60;
	window.open(_legionGuideUrl,'guide','height=' + windH + ',width=' + windW + ',left=' + windL + ',top=' + windT + ',toolbar=no,scrollbars=yes,menubar=no,resizable=no,location=no, status=no');
}
function _gotoGuidePage() {

	mixi.util.requestExternalNavigateTo(_legionGuideUrl);
}

function _getGameIFChargeParam(serverId) {

	var params = _getGameIFBaseParam(serverId);
	
	var postData = {};
	
	postData["providerId"] = _providerId;
	postData["titleId"] = _titleId;
	postData["serverId"] = serverId;
	
	postData["act"] = "charge";
	postData["memId"] = _userId;
	
	params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(postData);

	//console.log(params);
	return params;
}

function _gotoGameIFCharge(serverId) {
	
	gadgets.io.makeRequest(_gameIFServletUrl, function(resdata) {
	
		mixi.util.requestExternalNavigateTo(resdata.data.htmlText, mixi.util.ExternalSiteType.PAYMENT);
		
	}, _getGameIFChargeParam(serverId));
}

function _getGameIFBaseParam() {

	var params = {};
	
	params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
	params[gadgets.io.RequestParameters.AUTHORIZATION] = gadgets.io.AuthorizationType.SIGNED;
	params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
	
	return params;
}

function _getGameIFTitlePlayParam(serverId) {

	var params = _getGameIFBaseParam();
	
	var postData = {};
	
	postData["providerId"] = _providerId;
	postData["titleId"] = _titleId;
	
	if (serverId != null) { postData["serverId"] = serverId; }
	
	postData["memId"] = _userId;
	
	params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(postData);
	
	//console.log(params);
	return params;
}

function _doGameIFTitlePlay(serverId) {
	
	gadgets.io.makeRequest(_gameIFServletUrl, function(resdata) { _doGameIFResponse(resdata); }, _getGameIFTitlePlayParam(serverId));
}

function _getGameIFProxyParam(serverId, targetUri, targetParams) {

	var params = _getGameIFBaseParam(serverId);
	
	var postData = {};
	
	postData["providerId"] = _providerId;
	postData["titleId"] = _titleId;
	
	if (serverId != null) { postData["serverId"] = serverId; }
	
	postData["memId"] = _userId;
	postData["targetUri"] = targetUri;
	
	for (var key in targetParams) {
	
		postData[key] = targetParams[key];
	}
	
	params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(postData);

	//console.log(params);
	return params;
}

function _showFriendDetail(id) {

	if (window._showFriend == null || window._showFriend != id) {
		
		if (window._showFriend != null && window._showFriend != id && window._idIndexMap[window._showFriend] != null) {
		
			document.getElementById("thumbCell" + window._idIndexMap[window._showFriend]).style.border = "solid 2px #FFF";
		}
		
		window._showFriend = id;
		
		document.getElementById("friend_detail").style.display = "block";
		document.getElementById("start").style.display = "none";
	
		document.getElementById("g_leader").innerHTML = window._gameFriends[id]["leader"];
		document.getElementById("g_city").innerHTML = window._gameFriends[id]["city"];
		document.getElementById("g_city_x").innerHTML = window._gameFriends[id]["city_x"];
		document.getElementById("g_city_y").innerHTML = window._gameFriends[id]["city_y"];
		document.getElementById("g_race").innerHTML = window._gameFriends[id]["race"];
		document.getElementById("g_gods").innerHTML = window._gameFriends[id]["gods"];
		document.getElementById("g_godliness").innerHTML = window._gameFriends[id]["godliness"];
		document.getElementById("g_church").innerHTML = window._gameFriends[id]["church"];
		
		document.getElementById("thumbCell" + window._idIndexMap[id]).style.border = "solid 2px #F60";
		
	} else {
	
		window._showFriend = null;
		document.getElementById("thumbCell" + window._idIndexMap[id]).style.border = "solid 2px #FFF";
		document.getElementById("start").style.display = "block";
		document.getElementById("friend_detail").style.display = "none";
	}
	
	document.getElementById("friend_finish").style.display = "none";
}

function _doBackToFriendDetail() {

	document.getElementById("friend_detail").style.display = "block";
	document.getElementById("friend_finish").style.display = "none";
}

function _doShowPreviousFriendList() {
	
	if (window._curruntFriendListPage == null) { window._curruntFriendListPage = 1; }
	
	if (window._curruntFriendListPage > 1) {
	
		_doShowFriendList(window._curruntFriendListPage - 1);
	}
}

function _doShowNextFriendList() {
	
	if (window._curruntFriendListPage == null) { window._curruntFriendListPage = 1; }
		
	_doShowFriendList(window._curruntFriendListPage + 1);
}

function _doShowFriendList(pageNo) {
	
	for(var k = 0; k < 5; k++) {

		document.getElementById("friend" + k).href = "javascript:_inviteFriends();";
		document.getElementById("friend" + k).title = "友達を誘いましょう！";
		document.getElementById("friendThumb" + k).src = "http://test.www.game-if.com/opensocial/images/opensocial/mixi/img_no_friend.gif";
		document.getElementById("friendThumb" + k).alt = "友達を誘いましょう！";
		document.getElementById("thumbCell" + k).style.border = "solid 2px #FFF";
	}
	
	if (pageNo == null) { pageNo = 1; }
	
	window._idIndexMap = {};
	window._curruntFriendListPage = pageNo;
	
	var i = 0;
	var j = 0;
	
	for(var key in window._gameFriends) {

		if (i >= (pageNo - 1) * 5 && i < pageNo * 5) {
			
			document.getElementById("friend" + j).href = "javascript: _showFriendDetail(" + window._myFriends[key]["id"] + ");";
			document.getElementById("friend" + j).title = window._myFriends[key]["nickname"];
			document.getElementById("friendThumb" + j).src = window._myFriends[key]["thumbnailUrl"];
			document.getElementById("friendThumb" + j).alt = window._myFriends[key]["nickname"];
			
			window._idIndexMap[key] = j;
			
			j++;
		}
		i++;
	}
		
	window._showFriend = null;
	document.getElementById("friend_detail").style.display = "none";
	document.getElementById("friend_finish").style.display = "none";
	document.getElementById("start").style.display = "block";
}

function _doGetFriendGameInfo(serverId) {
	
	var friendIds = "";
	
	var i = 0;
	
	for(var key in window._myFriends) {
	
		if (i > 0) {
			
			friendIds = friendIds + ",";
		}
		
		friendIds = friendIds + window._myFriends[key]["id"];
		
		i++;
	}
	
	var targetParams = {};
	
	targetParams["pr.friendIds"] = friendIds;
	
	var reqParam = _getGameIFProxyParam(serverId, "opensocial/MyMics.asp", targetParams);
	
	gadgets.io.makeRequest(_gameIFProxyUrl, function(resdata) {

		//console.log(resdata);
		document.getElementById('proxyScript').innerHTML = resdata.data.htmlText;
		eval(document.getElementById("proxyScript").innerHTML);
		
		_doShowFriendList(1);
		
		setInterval("_doOpensocialActivity()",　30000);
		
	}, reqParam);
}

function _doGetFriends() {

	var ip = {};
	ip[opensocial.IdSpec.Field.USER_ID] = opensocial.IdSpec.PersonId.VIEWER;
	ip[opensocial.IdSpec.Field.GROUP_ID] = "FRIENDS";
	
	var idSpec = opensocial.newIdSpec(ip);
	
	var params = {};
	params[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS] = [ opensocial.Person.Field.PROFILE_URL ];
	params[opensocial.DataRequest.PeopleRequestFields.FILTER] = opensocial.DataRequest.FilterType.HAS_APP;
	params[opensocial.DataRequest.PeopleRequestFields.MAX] = 100;
	
	var req = opensocial.newDataRequest();
	
	req.add(req.newFetchPeopleRequest(idSpec, params), "friends");
		
	req.send( function(data) {

		if (!data.hadError()) {
		
			var item = data.get("friends");
			
			if (item.hadError()) {
			
				var code = item.getErrorCode();
				alert("エラー[ " + code + " ]が発生しました。");
				//TODO:画面遷移
				
			} else {
				
				var friends = data.get("friends").getData();
				
				window._friendsCount = friends.getTotalSize();
				
				friends.each( function(friend) {
					
					if (window._myFriends == null) {
					
						window._myFriends = new Object();
					}
					
					if (window._friendsIndex == null) {
					
						window._friendsIndex = 0;
					}
					
					var myFriend = new Object();
					
					myFriend["id"] = friend.getId();
					myFriend["nickname"] = friend.getDisplayName();
					myFriend["thumbnailUrl"] = friend.getField(opensocial.Person.Field.THUMBNAIL_URL);
					myFriend["profileUrl"] = friend.getField(opensocial.Person.Field.PROFILE_URL);
					
					window._myFriends[friend.getId()] = myFriend;
					
					window._friendsIndex = window._friendsIndex + 1;
					
					if (window._friendsCount == window._friendsIndex) {
					
						_doGetFriendGameInfo(_serverId);
					}
				});
			}
		}
	});
}

gadgets.util.runOnLoadHandlers( new function() {

	var req = opensocial.newDataRequest();
	var params = {};
	
	req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER, params), "viewer");
	
	req.send( function(data) {

		if (!data.hadError()) {
		
			var item = data.get("viewer");
			
			if (item.hadError()) {
			
				var code = item.getErrorCode();
				alert("エラー[ " + code + " ]が発生しました。");
				//TODO:画面遷移
				
			} else {
				
				_userId = item.getData().getId();
				_nickname = item.getData().getDisplayName();
				
				gadgets.io.makeRequest(_gameIFServletUrl, function(resdata) {

					//console.log(resdata);
					gadgets.window.adjustHeight(792);
					document.getElementById('target').innerHTML = resdata.data.htmlText;
					eval(document.getElementById("scriptSetServerId").innerHTML);
					_doGetFriends();
				
				}, _getGameIFTitlePlayParam(null));
			}
		}
	});
});

function _doSendMessage() {

	document.getElementById('mx_g_screen').style.visibility = 'hidden';
	
	var recipient = window._showFriend;
	var title = "";
	var body = "毎日5分から楽しめる「レジオン-創世伝説-for mixi」";
	
	var params = {};
	params[opensocial.Message.Field.TITLE] = title;
	var msg = opensocial.newMessage(body, params);
	
	opensocial.requestSendMessage(recipient, msg, function(response) {
		
		document.getElementById('success_message').innerHTML = "メッセージの送信が完了しました。";
		document.getElementById('mx_g_screen').style.visibility = 'visible';
	});
}

function _doSendGameFriendRequest() {
	
	var targetParams = {};
	
	targetParams["pr.friendId"] = window._showFriend;
	
	var reqParam = _getGameIFProxyParam(_serverId, "opensocial/ReqFriendRel.asp", targetParams);
	
	gadgets.io.makeRequest(_gameIFProxyUrl, function(resdata) {

		//console.log(resdata);
		document.getElementById('success_message').innerHTML = resdata.data.htmlText;
		document.getElementById("friend_detail").style.display = "none";
		document.getElementById("friend_finish").style.display = "block";
		
		document.body.style.cursor = "auto";
		
	}, reqParam);
	
	document.body.style.cursor = "wait";
}

function _doOpensocialActivity() {

	var reqParam = _getGameIFProxyParam(_serverId, "opensocial/GetOpensocialActivity.asp", {});
	
	gadgets.io.makeRequest(_gameIFProxyUrl, function(resdata) {

		//console.log(resdata);
		document.getElementById('proxyScript').innerHTML = resdata.data.htmlText;
		eval(document.getElementById("proxyScript").innerHTML);
		
		if (window._gameActivity != null) {
		
			document.getElementById('mx_g_screen').style.visibility = 'hidden';
			
			var params = {};
			params[opensocial.Activity.Field.TITLE] = window._gameActivity["message"];
			params[opensocial.Activity.Field.TITLE] = params[opensocial.Activity.Field.TITLE].replace('#NICKNAME#', _nickname);
			
			if (window._gameActivity["to_mem_id"] != null && window._gameActivity["to_mem_id"] != "") {
			
				params[mixi.ActivityField.RECIPIENTS] = [window._gameActivity["to_mem_id"]];
			}
			
			var activity = opensocial.newActivity(params);
			
			opensocial.requestCreateActivity(activity, opensocial.CreateActivityPriority.HIGH, function(response) {
			
				if (response.hadError()) {
					var code = response.getErrorCode();
				}

				document.getElementById('mx_g_screen').style.visibility = 'visible';
			});
		}
		
	}, reqParam);
}
</script>

  ]]></Content>
</Module>
